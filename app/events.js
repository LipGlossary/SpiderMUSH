// Generated by CoffeeScript 1.7.1
(function() {
  var Char, User, mongoose;

  mongoose = require('mongoose');

  User = require('../app/models/user');

  Char = require('../app/models/char');

  module.exports = function(app) {
    app.io.route('create', function(req) {
      switch (req.data[0]) {
        case 'char':
          return req.io.emit('create-char');
        case 'room':
          return req.io.emit('message', "I'm sorry, I cannot create rooms at this time.");
        case 'object':
          return req.io.emit('message', "I'm sorry, I cannot creat objects at this time.");
        case void 0:
          return req.io.emit('prompt', {
            message: "What would you like to create?\n    char    room    object",
            command: 'create',
            args: req.data
          });
        default:
          return req.io.emit('message', "I cannot edit \"" + req.data[0] + "\".");
      }
    });
    app.io.route('edit', function(req) {
      switch (req.data[0]) {
        case 'self':
          return User.findById(req.session.passport.user, function(err, user) {
            if (err != null) {
              return req.io.emit('error', err);
            } else {
              return Char.findById(user.chars[0], function(err, char) {
                if (err != null) {
                  return req.io.emit('error', err);
                } else {
                  req.session.editId = user.chars[0];
                  return req.io.emit('edit-char', char);
                }
              });
            }
          });
        case 'char':
          return User.findById(req.session.passport.user, function(err, user) {
            if (err != null) {
              return req.io.emit('error', err);
            } else {
              if (user.chars.length < 2) {
                return req.io.emit('message', "You don't have any characters to edit.");
              } else {
                return req.io.emit('message', "Sorry, I can't edit characters at this time.");
              }
            }
          });
        case 'room':
          return req.io.emit('message', "Sorry, I can't edit rooms at this time.");
        case 'object':
          return req.io.emit('message', "Sorry, I can't edit objects at this time.");
        case void 0:
          return req.io.emit('prompt', {
            message: 'What would you like to edit?\n    self    char    room    object',
            command: 'edit',
            args: req.data
          });
        default:
          return req.io.emit('message', "I cannot edit \"" + req.data[0] + "\".");
      }
    });
    app.io.route('create-char', function(req) {
      var newChar;
      newChar = {
        name: req.data.name,
        list: req.data.list,
        look: req.data.look,
        move: req.data.move,
        appear: req.data.appear
      };
      return Char.create(newChar, function(charErr, charData) {
        var key, value, _ref, _results;
        if (charErr != null) {
          _ref = charErr.errors;
          _results = [];
          for (key in _ref) {
            value = _ref[key];
            switch (value.path) {
              case 'name':
                switch (value.type) {
                  case 'unique':
                    _results.push(req.io.emit('message', "There is already a character with that name."));
                    break;
                  case 'required':
                    _results.push(req.io.emit('message', "The character must have a name."));
                    break;
                  default:
                    _results.push(req.io.emit('error', charErr));
                }
                break;
              case 'list':
                _results.push(req.io.emit('message', "The character must have a short description (\"list\" command)."));
                break;
              case 'look':
                _results.push(req.io.emit('message', "The character must have a long description (\"look\" command)."));
                break;
              case 'move':
                _results.push(req.io.emit('message', "The character must have a movement description."));
                break;
              case 'appear':
                _results.push(req.io.emit('message', "The character must have a [dis]appearance description."));
                break;
              default:
                _results.push(req.io.emit('error', charErr));
            }
          }
          return _results;
        } else {
          return User.findByIdAndUpdate(req.session.passport.user, {
            $push: {
              chars: charData._id
            }
          }, function(userErr, userData) {
            if (userErr != null) {
              return req.io.emit('error', userErr);
            } else {
              return req.io.emit('message', "The character \"" + req.data.name + "\" was created!");
            }
          });
        }
      });
    });
    return app.io.route('edit-char', function(req) {
      console.log("DATA: " + JSON.stringify(req.data));
      return Char.findByIdAndUpdate(req.session.editId, {
        $set: {
          name: req.data.name,
          list: req.data.list,
          look: req.data.look,
          move: req.data.move,
          appear: req.data.appear
        }
      }, function(err, data) {
        var key, value, _ref, _results;
        if (err != null) {
          console.log("ERROR: " + err);
          _ref = err.errors;
          _results = [];
          for (key in _ref) {
            value = _ref[key];
            switch (value.path) {
              case 'name':
                switch (value.type) {
                  case 'unique':
                    _results.push(req.io.emit('message', "There is already a character with that name."));
                    break;
                  case 'required':
                    _results.push(req.io.emit('message', "The character must have a name."));
                    break;
                  default:
                    _results.push(req.io.emit('error', err));
                }
                break;
              case 'list':
                _results.push(req.io.emit('message', "The character must have a short description (\"list\" command)."));
                break;
              case 'look':
                _results.push(req.io.emit('message', "The character must have a long description (\"look\" command)."));
                break;
              case 'move':
                _results.push(req.io.emit('message', "The character must have a movement description."));
                break;
              case 'appear':
                _results.push(req.io.emit('message', "The character must have a [dis]appearance description."));
                break;
              default:
                _results.push(req.io.emit('error', err));
            }
          }
          return _results;
        } else {
          return req.io.emit('message', "The character \"" + req.data.name + "\" was saved!");
        }
      });
    });
  };

}).call(this);
